{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "8f9ece01",
   "metadata": {
    "_cell_guid": "b1076dfc-b9ad-4769-8c92-a6c4dae69d19",
    "_uuid": "8f2839f25d086af736a60e9eeb907d3b93b6e0e5",
    "execution": {
     "iopub.execute_input": "2026-02-26T03:01:32.223144Z",
     "iopub.status.busy": "2026-02-26T03:01:32.222720Z",
     "iopub.status.idle": "2026-02-26T03:01:42.905878Z",
     "shell.execute_reply": "2026-02-26T03:01:42.904563Z"
    },
    "papermill": {
     "duration": 10.691185,
     "end_time": "2026-02-26T03:01:42.908341",
     "exception": false,
     "start_time": "2026-02-26T03:01:32.217156",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Requirement already satisfied: gymnasium in /usr/local/lib/python3.12/dist-packages (1.2.0)\r\n",
      "Collecting gymnasium\r\n",
      "  Downloading gymnasium-1.2.3-py3-none-any.whl.metadata (10 kB)\r\n",
      "Requirement already satisfied: numpy>=1.21.0 in /usr/local/lib/python3.12/dist-packages (from gymnasium) (2.0.2)\r\n",
      "Requirement already satisfied: cloudpickle>=1.2.0 in /usr/local/lib/python3.12/dist-packages (from gymnasium) (3.1.2)\r\n",
      "Requirement already satisfied: typing-extensions>=4.3.0 in /usr/local/lib/python3.12/dist-packages (from gymnasium) (4.15.0)\r\n",
      "Requirement already satisfied: farama-notifications>=0.0.1 in /usr/local/lib/python3.12/dist-packages (from gymnasium) (0.0.4)\r\n",
      "Downloading gymnasium-1.2.3-py3-none-any.whl (952 kB)\r\n",
      "\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m952.1/952.1 kB\u001b[0m \u001b[31m21.5 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\r\n",
      "\u001b[?25hInstalling collected packages: gymnasium\r\n",
      "  Attempting uninstall: gymnasium\r\n",
      "    Found existing installation: gymnasium 1.2.0\r\n",
      "    Uninstalling gymnasium-1.2.0:\r\n",
      "      Successfully uninstalled gymnasium-1.2.0\r\n",
      "\u001b[31mERROR: pip's dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.\r\n",
      "kaggle-environments 1.27.0 requires gymnasium==1.2.0, but you have gymnasium 1.2.3 which is incompatible.\r\n",
      "dopamine-rl 4.1.2 requires gym<=0.25.2, but you have gym 0.26.2 which is incompatible.\u001b[0m\u001b[31m\r\n",
      "\u001b[0mSuccessfully installed gymnasium-1.2.3\r\n",
      "Collecting stable-baselines3\r\n",
      "  Downloading stable_baselines3-2.7.1-py3-none-any.whl.metadata (4.8 kB)\r\n",
      "Requirement already satisfied: gymnasium<1.3.0,>=0.29.1 in /usr/local/lib/python3.12/dist-packages (from stable-baselines3) (1.2.3)\r\n",
      "Requirement already satisfied: numpy<3.0,>=1.20 in /usr/local/lib/python3.12/dist-packages (from stable-baselines3) (2.0.2)\r\n",
      "Requirement already satisfied: torch<3.0,>=2.3 in /usr/local/lib/python3.12/dist-packages (from stable-baselines3) (2.9.0+cpu)\r\n",
      "Requirement already satisfied: cloudpickle in /usr/local/lib/python3.12/dist-packages (from stable-baselines3) (3.1.2)\r\n",
      "Requirement already satisfied: pandas in /usr/local/lib/python3.12/dist-packages (from stable-baselines3) (2.3.3)\r\n",
      "Requirement already satisfied: matplotlib in /usr/local/lib/python3.12/dist-packages (from stable-baselines3) (3.10.0)\r\n",
      "Requirement already satisfied: typing-extensions>=4.3.0 in /usr/local/lib/python3.12/dist-packages (from gymnasium<1.3.0,>=0.29.1->stable-baselines3) (4.15.0)\r\n",
      "Requirement already satisfied: farama-notifications>=0.0.1 in /usr/local/lib/python3.12/dist-packages (from gymnasium<1.3.0,>=0.29.1->stable-baselines3) (0.0.4)\r\n",
      "Requirement already satisfied: filelock in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (3.20.3)\r\n",
      "Requirement already satisfied: setuptools in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (75.2.0)\r\n",
      "Requirement already satisfied: sympy>=1.13.3 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (1.14.0)\r\n",
      "Requirement already satisfied: networkx>=2.5.1 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (3.6.1)\r\n",
      "Requirement already satisfied: jinja2 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (3.1.6)\r\n",
      "Requirement already satisfied: fsspec>=0.8.5 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (2025.3.0)\r\n",
      "Requirement already satisfied: contourpy>=1.0.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib->stable-baselines3) (1.3.3)\r\n",
      "Requirement already satisfied: cycler>=0.10 in /usr/local/lib/python3.12/dist-packages (from matplotlib->stable-baselines3) (0.12.1)\r\n",
      "Requirement already satisfied: fonttools>=4.22.0 in /usr/local/lib/python3.12/dist-packages (from matplotlib->stable-baselines3) (4.61.1)\r\n",
      "Requirement already satisfied: kiwisolver>=1.3.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib->stable-baselines3) (1.4.9)\r\n",
      "Requirement already satisfied: packaging>=20.0 in /usr/local/lib/python3.12/dist-packages (from matplotlib->stable-baselines3) (25.0)\r\n",
      "Requirement already satisfied: pillow>=8 in /usr/local/lib/python3.12/dist-packages (from matplotlib->stable-baselines3) (11.3.0)\r\n",
      "Requirement already satisfied: pyparsing>=2.3.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib->stable-baselines3) (3.3.1)\r\n",
      "Requirement already satisfied: python-dateutil>=2.7 in /usr/local/lib/python3.12/dist-packages (from matplotlib->stable-baselines3) (2.9.0.post0)\r\n",
      "Requirement already satisfied: pytz>=2020.1 in /usr/local/lib/python3.12/dist-packages (from pandas->stable-baselines3) (2025.2)\r\n",
      "Requirement already satisfied: tzdata>=2022.7 in /usr/local/lib/python3.12/dist-packages (from pandas->stable-baselines3) (2025.3)\r\n",
      "Requirement already satisfied: six>=1.5 in /usr/local/lib/python3.12/dist-packages (from python-dateutil>=2.7->matplotlib->stable-baselines3) (1.17.0)\r\n",
      "Requirement already satisfied: mpmath<1.4,>=1.1.0 in /usr/local/lib/python3.12/dist-packages (from sympy>=1.13.3->torch<3.0,>=2.3->stable-baselines3) (1.3.0)\r\n",
      "Requirement already satisfied: MarkupSafe>=2.0 in /usr/local/lib/python3.12/dist-packages (from jinja2->torch<3.0,>=2.3->stable-baselines3) (3.0.3)\r\n",
      "Downloading stable_baselines3-2.7.1-py3-none-any.whl (188 kB)\r\n",
      "\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m188.0/188.0 kB\u001b[0m \u001b[31m6.9 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\r\n",
      "\u001b[?25hInstalling collected packages: stable-baselines3\r\n",
      "Successfully installed stable-baselines3-2.7.1\r\n"
     ]
    }
   ],
   "source": [
    "!pip install -U gymnasium\n",
    "!pip install stable-baselines3"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "bd34b4b3",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-02-26T03:01:42.918650Z",
     "iopub.status.busy": "2026-02-26T03:01:42.918278Z",
     "iopub.status.idle": "2026-02-26T03:01:46.214336Z",
     "shell.execute_reply": "2026-02-26T03:01:46.213457Z"
    },
    "papermill": {
     "duration": 3.303977,
     "end_time": "2026-02-26T03:01:46.216481",
     "exception": false,
     "start_time": "2026-02-26T03:01:42.912504",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "from typing import Optional\n",
    "import numpy as np\n",
    "import gymnasium as gym\n",
    "from gymnasium import spaces\n",
    "import numpy as np\n",
    "import torch"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "f525aeb5",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-02-26T03:01:46.225731Z",
     "iopub.status.busy": "2026-02-26T03:01:46.225288Z",
     "iopub.status.idle": "2026-02-26T03:01:46.250582Z",
     "shell.execute_reply": "2026-02-26T03:01:46.249610Z"
    },
    "papermill": {
     "duration": 0.032321,
     "end_time": "2026-02-26T03:01:46.252595",
     "exception": false,
     "start_time": "2026-02-26T03:01:46.220274",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "example_LOB = torch.tensor([\n",
    "    [55.8, 2, 55.76, 6, 55.7, 4, 55.82, 8, 55.88, 2, 55.89, 4, 0.8, 55.78, 0],\n",
    "    [55.78, 10, 55.73, 12, 55.71, 8, 55.81, 8, 55.84, 12, 55.87, 8, 0.65, 55.83, 1],\n",
    "    [55.78, 10, 55.74, 3, 55.73, 12, 55.81, 8, 55.84, 12, 55.89, 4, 0.6, 55.82, 1],\n",
    "    [55.76, 4, 55.75, 2, 55.74, 8, 55.81, 8, 55.82, 2, 55.84, 11, 0.82, 55.77, 0],\n",
    "    [55.81, 10, 55.79, 23, 55.78, 15, 55.83, 8, 55.85, 6, 55.93, 8, 0.44, 55.79, 0],\n",
    "])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "52500d50",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-02-26T03:01:46.262960Z",
     "iopub.status.busy": "2026-02-26T03:01:46.262610Z",
     "iopub.status.idle": "2026-02-26T03:01:46.269022Z",
     "shell.execute_reply": "2026-02-26T03:01:46.268174Z"
    },
    "papermill": {
     "duration": 0.0148,
     "end_time": "2026-02-26T03:01:46.271138",
     "exception": false,
     "start_time": "2026-02-26T03:01:46.256338",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "torch.Size([5, 15])"
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "example_LOB.shape"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "b31d3a50",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-02-26T03:01:46.280905Z",
     "iopub.status.busy": "2026-02-26T03:01:46.280220Z",
     "iopub.status.idle": "2026-02-26T03:01:46.298778Z",
     "shell.execute_reply": "2026-02-26T03:01:46.297875Z"
    },
    "papermill": {
     "duration": 0.025762,
     "end_time": "2026-02-26T03:01:46.300732",
     "exception": false,
     "start_time": "2026-02-26T03:01:46.274970",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "fee_pct = 0.0005\n",
    "\n",
    "class LOBEnv(gym.Env):\n",
    "    def __init__(self, orderbook, device):\n",
    "        # large_cpu_tensor should be pinned for speed\n",
    "        if device == 'cuda':\n",
    "            self.data = orderbook.pin_memory() \n",
    "        else:\n",
    "            self.data = orderbook\n",
    "        self.current_step = 0\n",
    "        self.max_steps = self.data.shape[0] - 1\n",
    "\n",
    "        self.initial_cash = 100_000.0\n",
    "        self.action_space = spaces.Discrete(3)\n",
    "\n",
    "    def reset(self, seed=None):\n",
    "        super().reset(seed=seed)\n",
    "        self.current_step = 0\n",
    "        \n",
    "        self.cash = self.initial_cash\n",
    "        self.total_balance = self.initial_cash\n",
    "        self.inventory = 0\n",
    "        self.entry_price = 0\n",
    "        self.steps_held = 0\n",
    "        self.transaction_costs = 0\n",
    "        self.total_return = 0\n",
    "        \n",
    "        return self.data[self.current_step].to(device, non_blocking=True), {}\n",
    "        \n",
    "    def _get_obs(self):\n",
    "        # Slice the CPU tensor and move ONLY this tiny piece to GPU\n",
    "        # This transfer is very fast for a single snapshot\n",
    "        return self.data[self.current_step].to(device, non_blocking=True)\n",
    "\n",
    "    def step(self, action):\n",
    "        # 1. Logic (PnL, Position tracking) stays on CPU/NumPy for simplicity\n",
    "        current_obs = self._get_obs()\n",
    "\n",
    "        book_depth = 3\n",
    "        bid_prices = current_obs[0:book_depth*2:2]\n",
    "        bid_volumes = current_obs[1:book_depth*2:2]\n",
    "        \n",
    "        ask_prices = current_obs[book_depth*2:book_depth*4:2]\n",
    "        ask_volumes = current_obs[(book_depth*2)+1:book_depth*4:2]\n",
    "\n",
    "        cumu_bid_volume = sum(bid_volumes)\n",
    "        cumu_ask_volume = sum(ask_volumes)\n",
    "        bid_ask_balance = (cumu_bid_volume - cumu_ask_volume) / (cumu_bid_volume + cumu_ask_volume)\n",
    "\n",
    "        bid_liquidity = sum(bid_prices * bid_volumes)\n",
    "        ask_liquidity = sum(ask_prices * ask_volumes)\n",
    "        \n",
    "        spread = current_obs[6] - current_obs[0]\n",
    "        #midpoint = (current_obs[0][6] + current_obs[0][0]) / 2\n",
    "        #self.total_balance = self.cash + (self.inventory * midpoint)\n",
    "\n",
    "        exec_shares = 0\n",
    "        exec_cost = 0\n",
    "        exec_fees = 0\n",
    "\n",
    "        if action == 1: # buy order\n",
    "            trade_budget = self.cash * 0.01 # 1% of portfolio value\n",
    "            remaining_budget = trade_budget\n",
    "            \n",
    "            for i in range(len(ask_prices)):\n",
    "                price = ask_prices[i].item()\n",
    "                volume = ask_volumes[i].item()\n",
    "\n",
    "                # get the maximum number of shares that can be traded based on budget\n",
    "                max_shares = remaining_budget / (price * (1 + fee_pct))\n",
    "\n",
    "                # take the minimum volume between what is available and wehat we can trade\n",
    "                shares_taken = min(volume, max_shares)\n",
    "\n",
    "                # compute metrics\n",
    "                cost = shares_taken * price\n",
    "                fees = cost * fee_pct\n",
    "                exec_shares += shares_taken\n",
    "                exec_cost += (cost + fees)\n",
    "                exec_fees += fees\n",
    "                remaining_budget -= (cost + fees)\n",
    "\n",
    "                if remaining_budget <= 0 or shares_taken < volume:\n",
    "                    break\n",
    "\n",
    "            if exec_shares > 0:\n",
    "                total_val = (self.inventory * self.entry_price) + exec_cost\n",
    "                self.inventory += exec_shares\n",
    "                self.entry_price = total_val / self.inventory\n",
    "                self.cash -= exec_cost\n",
    "                self.transaction_costs += exec_fees\n",
    "            \n",
    "        elif action == 2: # sell order\n",
    "            trade_vol = self.inventory\n",
    "            remaining_inventory = trade_vol\n",
    "\n",
    "            for i in range(len(bid_prices)):\n",
    "                price = bid_prices[i].item()\n",
    "                volume = bid_volumes[i].item()\n",
    "\n",
    "                # get the max number of shares that can be sold\n",
    "                shares_sold = min(volume, remaining_inventory)\n",
    "\n",
    "                # compute metrics\n",
    "                cost = shares_sold * price\n",
    "                fees = cost * fee_pct\n",
    "                exec_shares += shares_sold\n",
    "                exec_cost += (cost - fees)\n",
    "                exec_fees += fees\n",
    "                remaining_inventory -= shares_sold\n",
    "\n",
    "                if remaining_inventory <= 0 or shares_sold < volume:\n",
    "                    break\n",
    "            # handle edge case where not all shares are sold. give warning and execute remaining sale at the worst bid price\n",
    "            if exec_shares > 0:\n",
    "                self.total_return += exec_cost - (self.entry_price * self.inventory)\n",
    "                self.inventory = 0\n",
    "                self.entry_price = 0\n",
    "                self.cash += exec_cost\n",
    "                self.transaction_costs += exec_fees\n",
    "                \n",
    "        # 2. Increment step\n",
    "        self.current_step += 1\n",
    "\n",
    "        if self.current_step >= self.max_steps:\n",
    "            terminated = True\n",
    "            truncated = False\n",
    "            obs = self.data[-1].to(device, non_blocking=True) \n",
    "        elif self.total_balance <= 0:\n",
    "            terminated = False\n",
    "            truncated = True\n",
    "            obs = self.data[-1].to(device, non_blocking=True) \n",
    "        else:\n",
    "            terminated = False\n",
    "            truncated = False\n",
    "            obs = self._get_obs()\n",
    "\n",
    "        midpoint = (obs[6].item() + obs[0].item()) / 2\n",
    "        new_total_balance = self.cash + (self.inventory * midpoint)\n",
    "        reward = new_total_balance - self.total_balance\n",
    "        self.total_balance = new_total_balance\n",
    "\n",
    "        return obs, reward, terminated, truncated, {}"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "9154e578",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-02-26T03:01:46.310383Z",
     "iopub.status.busy": "2026-02-26T03:01:46.310007Z",
     "iopub.status.idle": "2026-02-26T03:01:46.315204Z",
     "shell.execute_reply": "2026-02-26T03:01:46.314353Z"
    },
    "papermill": {
     "duration": 0.012677,
     "end_time": "2026-02-26T03:01:46.317312",
     "exception": false,
     "start_time": "2026-02-26T03:01:46.304635",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "device = 'cuda' if torch.cuda.is_available() else 'mps' if torch.backends.mps.is_available() else 'cpu'\n",
    "env = LOBEnv(example_LOB, device)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "6989af24",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-02-26T03:01:46.326822Z",
     "iopub.status.busy": "2026-02-26T03:01:46.326471Z",
     "iopub.status.idle": "2026-02-26T03:01:46.332530Z",
     "shell.execute_reply": "2026-02-26T03:01:46.331475Z"
    },
    "papermill": {
     "duration": 0.013014,
     "end_time": "2026-02-26T03:01:46.334357",
     "exception": false,
     "start_time": "2026-02-26T03:01:46.321343",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "Discrete(3)"
      ]
     },
     "execution_count": 7,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "env.action_space"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "da9e22ed",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-02-26T03:01:46.344126Z",
     "iopub.status.busy": "2026-02-26T03:01:46.343744Z",
     "iopub.status.idle": "2026-02-26T03:01:46.441495Z",
     "shell.execute_reply": "2026-02-26T03:01:46.440093Z"
    },
    "papermill": {
     "duration": 0.105483,
     "end_time": "2026-02-26T03:01:46.443845",
     "exception": false,
     "start_time": "2026-02-26T03:01:46.338362",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "tensor([55.8000,  2.0000, 55.7600,  6.0000, 55.7000,  4.0000, 55.8200,  8.0000,\n",
      "        55.8800,  2.0000, 55.8900,  4.0000,  0.8000, 55.7800,  0.0000])\n",
      "tensor([55.7800, 10.0000, 55.7300, 12.0000, 55.7100,  8.0000, 55.8100,  8.0000,\n",
      "        55.8400, 12.0000, 55.8700,  8.0000,  0.6500, 55.8300,  1.0000])\n",
      "tensor([55.7800, 10.0000, 55.7400,  3.0000, 55.7300, 12.0000, 55.8100,  8.0000,\n",
      "        55.8400, 12.0000, 55.8900,  4.0000,  0.6000, 55.8200,  1.0000])\n",
      "tensor([55.7600,  4.0000, 55.7500,  2.0000, 55.7400,  8.0000, 55.8100,  8.0000,\n",
      "        55.8200,  2.0000, 55.8400, 11.0000,  0.8200, 55.7700,  0.0000])\n",
      "tensor([55.8100, 10.0000, 55.7900, 23.0000, 55.7800, 15.0000, 55.8300,  8.0000,\n",
      "        55.8500,  6.0000, 55.9300,  8.0000,  0.4400, 55.7900,  0.0000])\n"
     ]
    }
   ],
   "source": [
    "obs, info = env.reset()\n",
    "print(obs)\n",
    "\n",
    "for i in range(env.max_steps + 1):\n",
    "    action = 1\n",
    "    obs, reward, terminated, truncated, info = env.step(1)\n",
    "    print(obs)\n",
    "\n",
    "    if terminated or truncated:\n",
    "        break"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "d13ddac9",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-02-26T03:01:46.453782Z",
     "iopub.status.busy": "2026-02-26T03:01:46.453446Z",
     "iopub.status.idle": "2026-02-26T03:01:46.460330Z",
     "shell.execute_reply": "2026-02-26T03:01:46.459174Z"
    },
    "papermill": {
     "duration": 0.014376,
     "end_time": "2026-02-26T03:01:46.462297",
     "exception": false,
     "start_time": "2026-02-26T03:01:46.447921",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "tensor(55.8000)"
      ]
     },
     "execution_count": 9,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "example_LOB[0][0]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "d22e028d",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-02-26T03:01:46.472062Z",
     "iopub.status.busy": "2026-02-26T03:01:46.471720Z",
     "iopub.status.idle": "2026-02-26T03:01:46.477848Z",
     "shell.execute_reply": "2026-02-26T03:01:46.476970Z"
    },
    "papermill": {
     "duration": 0.013212,
     "end_time": "2026-02-26T03:01:46.479590",
     "exception": false,
     "start_time": "2026-02-26T03:01:46.466378",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "55.79999923706055"
      ]
     },
     "execution_count": 10,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "example_LOB[0][0].item()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "13f04941",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-02-26T03:01:46.489880Z",
     "iopub.status.busy": "2026-02-26T03:01:46.489524Z",
     "iopub.status.idle": "2026-02-26T03:01:46.504921Z",
     "shell.execute_reply": "2026-02-26T03:01:46.503754Z"
    },
    "papermill": {
     "duration": 0.023236,
     "end_time": "2026-02-26T03:01:46.507065",
     "exception": false,
     "start_time": "2026-02-26T03:01:46.483829",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "tensor([55.8000, 55.7600, 55.7000]) tensor([2., 6., 4.])\n",
      "12.0\n",
      "tensor([55.8200, 55.8800, 55.8900]) tensor([8., 2., 4.])\n",
      "14.0\n",
      "tensor(-0.0769)\n",
      "tensor(0.0200)\n",
      "tensor(668.9600)\n",
      "tensor(781.8800)\n"
     ]
    }
   ],
   "source": [
    "#LOB = example_LOB[0]\n",
    "#[LOB[i] for i in range(0, 6, 2)]\n",
    "book_depth = 3\n",
    "bid_prices = torch.tensor([example_LOB[0][i] for i in range(0, book_depth*2, 2)])\n",
    "bid_volumes = torch.tensor([example_LOB[0][i] for i in range(1, book_depth*2, 2)])\n",
    "\n",
    "ask_prices = torch.tensor([example_LOB[0][i] for i in range(book_depth*2, book_depth*4, 2)])\n",
    "ask_volumes = torch.tensor([example_LOB[0][i] for i in range((book_depth*2)+1, book_depth*4, 2)])\n",
    "\n",
    "print(bid_prices, bid_volumes)\n",
    "print(sum(bid_volumes).item())\n",
    "#print(sum(bid_prices * bid_volumes).item())\n",
    "\n",
    "print(ask_prices, ask_volumes)\n",
    "print(sum(ask_volumes).item())\n",
    "\n",
    "cumu_bid_volume = sum(bid_volumes)\n",
    "cumu_ask_volume = sum(ask_volumes)\n",
    "orderbook_imbalance = (cumu_bid_volume - cumu_ask_volume) / (cumu_bid_volume + cumu_ask_volume)\n",
    "\n",
    "print(orderbook_imbalance)\n",
    "\n",
    "spread = example_LOB[0][6] - example_LOB[0][0]\n",
    "print(spread)\n",
    "\n",
    "bid_liquidity = sum(bid_prices * bid_volumes)\n",
    "ask_liquidity = sum(ask_prices * ask_volumes)\n",
    "\n",
    "print(bid_liquidity)\n",
    "print(ask_liquidity)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "5851a170",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-02-26T03:01:46.518368Z",
     "iopub.status.busy": "2026-02-26T03:01:46.517959Z",
     "iopub.status.idle": "2026-02-26T03:01:46.524198Z",
     "shell.execute_reply": "2026-02-26T03:01:46.523113Z"
    },
    "papermill": {
     "duration": 0.014929,
     "end_time": "2026-02-26T03:01:46.526274",
     "exception": false,
     "start_time": "2026-02-26T03:01:46.511345",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "1000.0"
      ]
     },
     "execution_count": 12,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "max_trade_amount = 100_000 * 0.01 # 1% of portfolio value\n",
    "max_trade_amount"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "ce7ac190",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-02-26T03:01:46.536638Z",
     "iopub.status.busy": "2026-02-26T03:01:46.536304Z",
     "iopub.status.idle": "2026-02-26T03:01:46.542898Z",
     "shell.execute_reply": "2026-02-26T03:01:46.541996Z"
    },
    "papermill": {
     "duration": 0.013912,
     "end_time": "2026-02-26T03:01:46.544597",
     "exception": false,
     "start_time": "2026-02-26T03:01:46.530685",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "tensor([55.8000, 55.7600, 55.7000])\n",
      "tensor([2., 6., 4.])\n"
     ]
    }
   ],
   "source": [
    "print(example_LOB[0][0:6:2])\n",
    "print(example_LOB[0][1:6:2])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "2ff54c29",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-02-26T03:01:46.555446Z",
     "iopub.status.busy": "2026-02-26T03:01:46.555013Z",
     "iopub.status.idle": "2026-02-26T03:01:46.560244Z",
     "shell.execute_reply": "2026-02-26T03:01:46.559341Z"
    },
    "papermill": {
     "duration": 0.013333,
     "end_time": "2026-02-26T03:01:46.562230",
     "exception": false,
     "start_time": "2026-02-26T03:01:46.548897",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "bid_prices = example_LOB[0][book_depth*2:book_depth*4:2]\n",
    "bid_volumes = example_LOB[0][(book_depth*2)+1:book_depth*4:2]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "ddde6d7f",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-02-26T03:01:46.572770Z",
     "iopub.status.busy": "2026-02-26T03:01:46.572412Z",
     "iopub.status.idle": "2026-02-26T03:01:46.579309Z",
     "shell.execute_reply": "2026-02-26T03:01:46.578259Z"
    },
    "papermill": {
     "duration": 0.014635,
     "end_time": "2026-02-26T03:01:46.581348",
     "exception": false,
     "start_time": "2026-02-26T03:01:46.566713",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "tensor([55.8200, 55.8800, 55.8900])\n",
      "tensor([8., 2., 4.])\n"
     ]
    }
   ],
   "source": [
    "print(bid_prices)\n",
    "print(bid_volumes)"
   ]
  }
 ],
 "metadata": {
  "kaggle": {
   "accelerator": "none",
   "dataSources": [],
   "dockerImageVersionId": 31286,
   "isGpuEnabled": false,
   "isInternetEnabled": true,
   "language": "python",
   "sourceType": "notebook"
  },
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.12"
  },
  "papermill": {
   "default_parameters": {},
   "duration": 18.669151,
   "end_time": "2026-02-26T03:01:47.507831",
   "environment_variables": {},
   "exception": null,
   "input_path": "__notebook__.ipynb",
   "output_path": "__notebook__.ipynb",
   "parameters": {},
   "start_time": "2026-02-26T03:01:28.838680",
   "version": "2.6.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
